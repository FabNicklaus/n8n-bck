{"createdAt":"2025-02-12T00:07:48.015Z","updatedAt":"2025-02-12T01:40:15.000Z","id":"ALd82okW7TKn6uev","name":"Scrape and store data from multiple websites","active":false,"nodes":[{"parameters":{},"name":"On clicking 'execute'","type":"n8n-nodes-base.manualTrigger","position":[-3540,340],"typeVersion":1,"id":"c0ac173b-fd4b-467e-81fd-e114e2d4da81"},{"parameters":{"url":"https://www.theswiftcodes.com/browse-by-country/","responseFormat":"string","options":{}},"name":"HTTP Request","type":"n8n-nodes-base.httpRequest","position":[-3080,340],"typeVersion":1,"id":"5435c3d2-43c9-4fac-ae30-36f1d0bb4bed"},{"parameters":{"extractionValues":{"values":[{"key":"countries","cssSelector":"ol > li > a","returnValue":"attribute","attribute":"href","returnArray":true}]},"options":{}},"name":"HTML Extract","type":"n8n-nodes-base.htmlExtract","position":[-2900,340],"typeVersion":1,"id":"cf07e61f-2e25-45d0-ae29-e3ba2041c132"},{"parameters":{"batchSize":1,"options":{"reset":false}},"name":"SplitInBatches","type":"n8n-nodes-base.splitInBatches","position":[-2500,340],"typeVersion":1,"id":"ef4dbd58-d2a1-4293-afcd-b4b9a305a36d"},{"parameters":{"url":"={{$node[\"Set\"].json[\"url\"]}}","responseFormat":"file","options":{}},"name":"HTTP Request1","type":"n8n-nodes-base.httpRequest","position":[-1160,260],"typeVersion":1,"id":"d4661a82-9959-4452-a0dd-ae6f2d67f53c"},{"parameters":{"sourceData":"binary","extractionValues":{"values":[{"key":"next_button","cssSelector":"span.next > a","returnValue":"attribute","attribute":"href"},{"key":"names","cssSelector":"td.table-name","returnArray":true},{"key":"swifts","cssSelector":"td.table-swift","returnArray":true},{"key":"cities","cssSelector":"td.table-city","returnArray":true},{"key":"branches","cssSelector":"td.table-branch","returnArray":true}]},"options":{}},"name":"HTML Extract1","type":"n8n-nodes-base.htmlExtract","position":[-660,120],"typeVersion":1,"id":"a05a185c-f8c0-44c2-9095-92bca1382628"},{"parameters":{"operation":"insert","collection":"swifts.meetup","fields":"iso_code,country,page,name,branch,city,swift_code,createdAt,updatedAt","options":{"dateFields":"createdAt,updatedAt"}},"name":"MongoDB1","type":"n8n-nodes-base.mongoDb","position":[-120,120],"typeVersion":1,"id":"09576450-8dd5-40ee-b3fc-9f4783f96cef","credentials":{"mongoDb":{"id":null,"name":"db-mongo"}}},{"parameters":{"group":"geographic","tool":"getCountryNormalized","country":"={{$node[\"SplitInBatches\"].json[\"country\"].replace(/[\\/0-9]/g, \"\")}}","additionalOptions":{}},"name":"uProc","type":"n8n-nodes-base.uproc","position":[-2300,340],"typeVersion":1,"id":"6dfe53dd-e6af-43dc-b7ac-5fa8216db820","credentials":{"uprocApi":{"id":null,"name":"uproc-miquel"}}},{"parameters":{"functionCode":"var newItems = [];\n\nfor (i = 0; i < items[0].json.swifts.length; i++) {\n  var item = {\n    iso_code: $node['uProc'].json.message.code,\n    country: $node['SplitInBatches'].json.country.replace(/[-\\/0-9]/g, \"\"),\n    page: $node['Set Page to Scrape'].json.page,\n    name: items[0].json.names[i],\n    city: items[0].json.cities[i],\n    branch: items[0].json.branches[i],\n    swift_code: items[0].json.swifts[i],\n    createdAt: new Date(),\n    updatedAt: new Date()\n  }\n  newItems.push({json: item});\n}\n\nreturn newItems;\n\n"},"name":"Prepare Documents","type":"n8n-nodes-base.function","position":[-480,120],"typeVersion":1,"id":"f4f47b3a-e257-45d6-a4b0-33821282a8d7"},{"parameters":{"conditions":{"string":[{"value1":"={{$node[\"SplitInBatches\"].context[\"noItemsLeft\"] + \"\"}}","value2":"true"}]}},"name":"More Countries","type":"n8n-nodes-base.if","position":[-600,620],"typeVersion":1,"id":"cbe99e4c-fcb7-46fb-9d67-1307aa95af78"},{"parameters":{"functionCode":"const staticData = getWorkflowStaticData('global');\n\nitem.page = \"\";\nif (staticData.page && staticData.page.length) {\n  item.page = staticData.page;\n} else {\n  item.page = $node['SplitInBatches'].json.country;\n}\nreturn item;\n"},"name":"Set Page to Scrape","type":"n8n-nodes-base.functionItem","position":[-2120,200],"typeVersion":1,"id":"14251b1e-3688-44c4-a3d9-4f3e18f330d9"},{"parameters":{"conditions":{"string":[{"value1":"={{$json[\"more_pages\"] + \"\"}}","value2":"true"}]}},"name":"More Pages","type":"n8n-nodes-base.if","position":[-340,540],"typeVersion":1,"id":"4d5869a2-752f-4479-a00b-9c5b665a4c83"},{"parameters":{"functionCode":"var next_page = $node['HTML Extract1'].json.next_button && $node['HTML Extract1'].json.next_button.length ? $node['HTML Extract1'].json.next_button : \"\";\nvar more_pages = next_page.length > 0;\nconst staticData = getWorkflowStaticData('global');\n\n//all current items are after date: needs pagination\nif (more_pages) {\n  staticData.page = next_page;\n} else {\n  //don't check more items in previous pages;\n  delete staticData.page;\n}\n\nreturn [\n  {\n    json: {\n      more_pages: more_pages\n    }\n  }\n];\n"},"name":"Set More Pages","type":"n8n-nodes-base.function","position":[80,120],"typeVersion":1,"id":"67da49e7-54f0-4bb3-a599-4722b81ccd55"},{"parameters":{"values":{"string":[{"name":"url","value":"=https://www.theswiftcodes.com{{$node[\"Set Page to Scrape\"].json[\"page\"]}}"}]},"options":{}},"name":"Set","type":"n8n-nodes-base.set","position":[-1960,200],"typeVersion":1,"id":"8f37e22f-affe-49e7-aecc-1d82af0f38c5"},{"parameters":{"functionCode":"var generateNameFromUrl = function(url){\n    return url.replace(/[^a-z0-9]/gi, \"_\");\n}\n\nitem.file = generateNameFromUrl(item.url) + \".html\"\nreturn item;"},"name":"Generate filename","type":"n8n-nodes-base.functionItem","position":[-1800,140],"typeVersion":1,"id":"7ac9781b-80fd-493b-9ec2-150479d0e418"},{"parameters":{"filePath":"=/home/node/.cache/scrapper/{{$json[\"file\"]}}"},"name":"Read Binary File","type":"n8n-nodes-base.readBinaryFile","position":[-1640,140],"typeVersion":1,"alwaysOutputData":true,"id":"e024207a-77e4-43f1-a45c-86b254eca943","continueOnFail":true},{"parameters":{"conditions":{"string":[{"value1":"={{$node[\"Read Binary File\"].binary.data.mimeType}}","value2":"text/html"}]}},"name":"File exists?","type":"n8n-nodes-base.if","position":[-1460,140],"typeVersion":1,"id":"1f573eef-be7b-4cf2-a89b-93a558776403"},{"parameters":{"fileName":"=/home/node/.cache/scrapper/{{$node[\"Generate filename\"].json[\"file\"]}}","dataPropertyName":"=data","options":{}},"name":"Write Binary File","type":"n8n-nodes-base.writeBinaryFile","position":[-1000,260],"typeVersion":1,"id":"9d968169-0168-497d-8fab-f4b22057632b"},{"parameters":{"filePath":"=/home/node/.cache/scrapper/{{$json[\"file\"]}}"},"name":"Read Binary File1","type":"n8n-nodes-base.readBinaryFile","position":[-840,120],"typeVersion":1,"alwaysOutputData":true,"id":"5a285f7e-1d3d-46b7-8e23-5ecadda715f7","continueOnFail":true},{"parameters":{"functionCode":"const waitTimeSeconds = 1;\n\nreturn new Promise((resolve) => {\n  setTimeout(() => {\n    resolve([]);\n  }, waitTimeSeconds * 1000);\n});\n"},"name":"Wait","type":"n8n-nodes-base.function","position":[-1320,260],"typeVersion":1,"alwaysOutputData":true,"id":"b7a8528b-2ff9-4117-b3fd-9971639f290b","continueOnFail":true},{"parameters":{"functionCode":"return items[0].json.countries.map(function(country) {\n  return {\n  json: {country: country}\n  }\n});"},"name":"Prepare countries","type":"n8n-nodes-base.function","position":[-2700,340],"typeVersion":1,"id":"30a7af3e-7577-4d79-b4e1-1509709df5e8"},{"parameters":{"command":"mkdir -p  /home/node/.cache/scrapper/"},"name":"Create Directory","type":"n8n-nodes-base.executeCommand","position":[-3340,340],"typeVersion":1,"id":"87dc9a0c-ac41-41ae-bc2f-91c2d1d2072c","continueOnFail":true},{"parameters":{"collection":"swifts.meetup","options":{},"query":"={\"swift_code\": \"{{$json[\"swift_code\"]}}\"}"},"name":"MongoDB","type":"n8n-nodes-base.mongoDb","position":[-300,40],"executeOnce":false,"typeVersion":1,"alwaysOutputData":true,"id":"8ba7d0c4-5fc8-4ef0-a89b-04fa1d9baefa","credentials":{"mongoDb":{"id":null,"name":"db-mongo"}},"disabled":true}],"connections":{"Set":{"main":[[{"node":"Generate filename","type":"main","index":0}]]},"Wait":{"main":[[{"node":"HTTP Request1","type":"main","index":0}]]},"uProc":{"main":[[{"node":"Set Page to Scrape","type":"main","index":0}]]},"MongoDB1":{"main":[[{"node":"Set More Pages","type":"main","index":0}]]},"More Pages":{"main":[[{"node":"Set Page to Scrape","type":"main","index":0}],[{"node":"More Countries","type":"main","index":0}]]},"File exists?":{"main":[[{"node":"Read Binary File1","type":"main","index":0}],[{"node":"Wait","type":"main","index":0}]]},"HTML Extract":{"main":[[{"node":"Prepare countries","type":"main","index":0}]]},"HTTP Request":{"main":[[{"node":"HTML Extract","type":"main","index":0}]]},"HTML Extract1":{"main":[[{"node":"Prepare Documents","type":"main","index":0}]]},"HTTP Request1":{"main":[[{"node":"Write Binary File","type":"main","index":0}]]},"More Countries":{"main":[[],[{"node":"SplitInBatches","type":"main","index":0}]]},"Set More Pages":{"main":[[{"node":"More Pages","type":"main","index":0}]]},"SplitInBatches":{"main":[[{"node":"uProc","type":"main","index":0}]]},"Create Directory":{"main":[[{"node":"HTTP Request","type":"main","index":0}]]},"Read Binary File":{"main":[[{"node":"File exists?","type":"main","index":0}]]},"Generate filename":{"main":[[{"node":"Read Binary File","type":"main","index":0}]]},"Prepare Documents":{"main":[[{"node":"MongoDB1","type":"main","index":0}]]},"Prepare countries":{"main":[[{"node":"SplitInBatches","type":"main","index":0}]]},"Read Binary File1":{"main":[[{"node":"HTML Extract1","type":"main","index":0}]]},"Write Binary File":{"main":[[{"node":"Read Binary File1","type":"main","index":0}]]},"Set Page to Scrape":{"main":[[{"node":"Set","type":"main","index":0}]]},"On clicking 'execute'":{"main":[[{"node":"Create Directory","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"ec63a714-719d-450a-9154-1771eebef83c","triggerCount":0,"tags":[{"createdAt":"2025-02-12T01:37:01.104Z","updatedAt":"2025-02-12T01:37:01.104Z","id":"H0b9SWuMKqfPgJxO","name":"SCRAPING"},{"createdAt":"2025-02-11T23:59:41.483Z","updatedAt":"2025-02-14T16:18:26.979Z","id":"dzhL8PxGOvRSKz2J","name":"ANCORA IN TEST"}]}