{"createdAt":"2025-02-27T14:44:51.394Z","updatedAt":"2025-02-27T14:45:00.000Z","id":"DJyF8YmgwHszs6ft","name":"Parallel subflows","active":false,"nodes":[{"parameters":{},"id":"bf78ab54-0f81-402a-8845-e12691b22e4c","name":"When clicking ‘Test workflow’","type":"n8n-nodes-base.manualTrigger","position":[-220,120],"typeVersion":1},{"parameters":{"options":{}},"id":"44fa14e0-0fed-492d-8767-c74b8958ac0c","name":"Loop Over Items","type":"n8n-nodes-base.splitInBatches","position":[220,120],"typeVersion":3},{"parameters":{"resume":"webhook","httpMethod":"POST","responseMode":"responseNode","options":{}},"id":"ef9fe156-c10a-4853-8562-cbcd67083602","name":"Webhook Callback Wait","type":"n8n-nodes-base.wait","position":[920,160],"webhookId":"5cd058b4-48c8-449a-9c09-959a5b8a2b48","typeVersion":1.1},{"parameters":{"jsCode":"let json = $('If All Finished').first().json;\nif (!json.finishedSet) json.finishedSet = [];\nlet finishedItemId = $('Webhook Callback Wait').item.json.body.finishedItemId;\nif (!json.finishedSet[finishedItemId]) json.finishedSet.push(finishedItemId);\nreturn [json];"},"id":"7fb2475b-db61-4ab6-9861-e876ccf75929","name":"Update finishedSet","type":"n8n-nodes-base.code","position":[1140,160],"typeVersion":2},{"parameters":{"assignments":{"assignments":[{"id":"193ab8f1-0e23-491c-914e-b8b26b0160f7","name":"finishedSet","type":"array","value":"[]"}]},"options":{}},"id":"ded1a91a-c146-42f8-be8a-e01eef007e86","name":"Initialize finishedSet","type":"n8n-nodes-base.set","position":[440,-20],"executeOnce":true,"typeVersion":3.4},{"parameters":{"jsCode":"return [\n  {requestId: 'req4567'},\n  {requestId: 'req8765'},\n  {requestId: 'req1234'}\n];"},"id":"277e9e52-a1cb-472d-b84f-9c486ef4b849","name":"Simulate Multi-Item for Parallel Processing","type":"n8n-nodes-base.code","position":[-20,120],"typeVersion":2},{"parameters":{"conditions":{"options":{"version":1,"leftValue":"","caseSensitive":true,"typeValidation":"strict"},"combinator":"and","conditions":[{"id":"385c3149-3623-4dd2-9022-770c32f82421","operator":{"type":"number","operation":"gte"},"leftValue":"={{ $json.finishedSet.length }}","rightValue":"={{ $('Simulate Multi-Item for Parallel Processing').all().length }}"}]},"options":{}},"id":"30031dbf-9b98-4837-83f3-d67f580e0c92","name":"If All Finished","type":"n8n-nodes-base.if","position":[660,-20],"typeVersion":2},{"parameters":{"method":"POST","url":"={{ $env.WEBHOOK_URL }}/webhook/parallel-subworkflow-target","sendHeaders":true,"headerParameters":{"parameters":[{"name":"callbackurl","value":"={{ $execution.resumeUrl }}"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"requestItemId","value":"={{ $json.requestId }}"}]},"options":{}},"id":"7b411466-52f1-448f-883e-a372837396e9","name":"Start Sub-Workflow via Webhook","type":"n8n-nodes-base.httpRequest","position":[380,360],"typeVersion":4.2},{"parameters":{"options":{}},"id":"8300d663-6255-4fec-8713-f6bfae3ff9b3","name":"Acknowledge Finished","type":"n8n-nodes-base.respondToWebhook","position":[980,380],"typeVersion":1.1},{"parameters":{"content":"### Start Multiple Sub-Workflows Asynchronously\n* Note: Callback/Webhook \"internal\" Base-URL should be configured in the n8n instance to reference the k8s service name and internal port.","height":109,"width":390,"color":3},"id":"8e3d4eed-c310-4dc3-bc91-73fb8a4cdbf0","name":"Sticky Note","type":"n8n-nodes-base.stickyNote","position":[-80,320],"typeVersion":1},{"parameters":{"content":"### Pseudo-Synchronously Wait for All Sub-Workflows to finish","height":80,"width":283,"color":3},"id":"aa109ce2-3a76-4624-a013-3a216f60a634","name":"Sticky Note1","type":"n8n-nodes-base.stickyNote","position":[940,80],"typeVersion":1},{"parameters":{},"id":"d7a3ccc1-ee32-4346-8f9b-658536fda8b1","name":"Continue Workflow (noop)","type":"n8n-nodes-base.noOp","position":[980,-100],"typeVersion":1},{"parameters":{"content":"## Main/Parent Workflow\n* This starts multiple executions of the sub-workflow in parallel and then loops until they all report back.","height":684.1818181818179,"width":1577.931818181817},"id":"cf7369de-27fe-455b-a646-479fd0d058d0","name":"Sticky Note3","type":"n8n-nodes-base.stickyNote","position":[-260,-120],"typeVersion":1},{"parameters":{"content":"### Sub-Workflow\n**Cut/Paste this into a separate workflow, and activate it!!!**","height":189.2194473140495,"width":1477.331211260329},"id":"b61943c6-883e-40b0-8c72-cddf4f8b5725","name":"Sticky Note2","type":"n8n-nodes-base.stickyNote","position":[-240,600],"typeVersion":1},{"parameters":{},"id":"30b32d40-972a-460a-8d5c-4700af400385","name":"Wait","type":"n8n-nodes-base.wait","position":[640,640],"webhookId":"2d62e5c2-ad4a-4e90-a075-7ca5212e015a","typeVersion":1.1},{"parameters":{"method":"POST","url":"={{ $('Webhook').item.json.headers.callbackurl }}","sendBody":true,"bodyParameters":{"parameters":[{"name":"finishedItemId","value":"={{ $('Webhook').item.json.body.requestItemId }}"}]},"options":{}},"id":"b541ddae-2fcd-4e9b-9c04-d2b33f9dead1","name":"Call Resume on Parent Workflow","type":"n8n-nodes-base.httpRequest","position":[860,640],"retryOnFail":true,"typeVersion":4.2,"waitBetweenTries":3000,"notes":"The callback resumes the parent workflow and reports which item finished.  There could be a race condition if the parent workflow was just resumed by a different sub-workflow but hasn't entered a webhook-wait again yet.  The delay and retry mitigates for the possibility that multiple subtasks complete and call back at once."},{"parameters":{"respondWith":"json","responseBody":"={{ \n{\n  \"finishedItemId\": $json.body.requestItemId\n}\n}}","options":{}},"id":"f3d45934-a763-4a45-a701-a3fa8e05a08b","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","position":[420,640],"typeVersion":1.1},{"parameters":{"httpMethod":"POST","path":"parallel-subworkflow-target","responseMode":"responseNode","options":{}},"id":"6de28c55-db52-4faa-9fb5-6895012ad029","name":"Webhook","type":"n8n-nodes-base.webhook","position":[200,640],"webhookId":"14776b45-77d7-4220-808f-2d0a38bec4de","typeVersion":2}],"connections":{"Wait":{"main":[[{"node":"Call Resume on Parent Workflow","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"If All Finished":{"main":[[{"node":"Continue Workflow (noop)","type":"main","index":0}],[{"node":"Webhook Callback Wait","type":"main","index":0}]]},"Loop Over Items":{"main":[[{"node":"Initialize finishedSet","type":"main","index":0}],[{"node":"Start Sub-Workflow via Webhook","type":"main","index":0}]]},"Respond to Webhook":{"main":[[{"node":"Wait","type":"main","index":0}]]},"Update finishedSet":{"main":[[{"node":"Acknowledge Finished","type":"main","index":0}]]},"Acknowledge Finished":{"main":[[{"node":"If All Finished","type":"main","index":0}]]},"Webhook Callback Wait":{"main":[[{"node":"Update finishedSet","type":"main","index":0}]]},"Initialize finishedSet":{"main":[[{"node":"If All Finished","type":"main","index":0}]]},"Start Sub-Workflow via Webhook":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"When clicking ‘Test workflow’":{"main":[[{"node":"Simulate Multi-Item for Parallel Processing","type":"main","index":0}]]},"Simulate Multi-Item for Parallel Processing":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"ce094532-b525-41cb-8474-25bb9f4320c4","triggerCount":0,"tags":[{"createdAt":"2025-02-12T00:06:31.183Z","updatedAt":"2025-02-16T12:09:52.918Z","id":"RAEtntqG5GvQKAMI","name":"AD USO INTERNO"},{"createdAt":"2025-02-11T23:59:41.483Z","updatedAt":"2025-02-14T16:18:26.979Z","id":"dzhL8PxGOvRSKz2J","name":"ANCORA IN TEST"}]}