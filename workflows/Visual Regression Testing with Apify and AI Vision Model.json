{"createdAt":"2025-02-12T01:07:36.121Z","updatedAt":"2025-02-12T01:27:21.000Z","id":"A0nPJQJ2h9ajOKxe","name":"Visual Regression Testing with Apify and AI Vision Model","active":false,"nodes":[{"parameters":{"operation":"download","fileId":{"__rl":true,"mode":"id","value":"={{ $json.base }}"},"options":{"binaryPropertyName":"data_1"}},"id":"f2ec1726-26b8-474f-8f10-87c08a9a7d38","name":"Base Image","type":"n8n-nodes-base.googleDrive","position":[2660,580],"typeVersion":3},{"parameters":{"modelName":"models/gemini-1.5-pro-latest","options":{}},"id":"5707faf8-337a-4edb-90c7-6479db996b88","name":"Google Gemini Chat Model","type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","position":[3520,820],"typeVersion":1},{"parameters":{"schemaType":"manual","inputSchema":"{\n  \"type\": \"array\",\n  \"items\": {\n    \"type\": \"object\",\n\t\"properties\": {\n\t\t\"type\": {\n    \t\t\"type\": \"string\",\n            \"description\": \"type of regression. One of text, number, image, color or position.\"\n  \t\t},\n\t\t\"description\": { \"type\": \"string\" },\n        \"previous_state\": { \"type\": \"string\" },\n        \"current_state\": { \"type\": \"string\" }\n\t}\n  }\n}"},"id":"481f2978-930a-46b0-8684-fe612e69fd30","name":"Structured Output Parser","type":"@n8n/n8n-nodes-langchain.outputParserStructured","position":[3720,820],"typeVersion":1.2},{"parameters":{"content":"### Part A. Generate Base Images\nBefore we can run our visual regression tests, we must generate a series of base screenshots to compare against. This part of the workflow uses an external website screenshotting service, [Apify.com](https://www.apify.com?fpr=414q6), to achieve this. This part of the workflow should only be run when we want to update our base screenshots.","height":180.74812634463558,"width":405.95003875719203,"color":4},"id":"a2a61dca-7cab-47ee-a9cc-847c4d6ba90b","name":"Sticky Note","type":"n8n-nodes-base.stickyNote","position":[60,-60],"typeVersion":1},{"parameters":{"content":"## 5. Download Base and Generate new Webpage Screenshot\n[Learn more about Apify.com](https://www.apify.com?fpr=414q6)\n\nLooping for each webpage, we'll do 2 tasks (1) download the base screenshot for the url and (2) and use our [Apify.com](https://www.apify.com?fpr=414q6) webpage screenshot actor again to generate a fresh screenshot.","height":548.4621171664835,"width":702.1744987652204,"color":7},"id":"4ca77c4d-c8ee-4216-af73-ecbb69951a62","name":"Sticky Note1","type":"n8n-nodes-base.stickyNote","position":[2580,420],"typeVersion":1},{"parameters":{"content":"## 6. Compare Screenshots using Vision Model\n[Read more about the basic LLM chain](https://docs.n8n.io/integrations/builtin/cluster-nodes/root-nodes/n8n-nodes-langchain.chainllm/)\n\nTo carry out our visual regression test, we need to send both screenshots simultaneously to our Vision model. This is easily achieved using n8n's built-in basic LLM chain where we can define two user messages of the binary type. For our vision model, we'll use Google's Gemini but any capable vision model will also do the job. A Structured Output Parser is used here to return the AI's response in JSON format, this is for easier formatting purposes which we'll get to in the next step.","height":548.702446115556,"width":759.5372282495247,"color":7},"id":"ddfed706-a538-4eb1-a70e-26d187941d83","name":"Sticky Note2","type":"n8n-nodes-base.stickyNote","position":[3300,420],"typeVersion":1},{"parameters":{"content":"## 7. Create Report In Linear\n[Learn more about integrating with Linear.app](https://docs.n8n.io/integrations/builtin/app-nodes/n8n-nodes-base.linear)\n\nFor the final step, we'll generate a simple report which will capture any changes detected in our webpages list. Let's do this by first combining our webpages with their test results and filter out any in the page where no changes were detected. Next, we'll aggregate all changes into the Linear.app node which will be formatted into a markdown snippet and used to create a new issue in Linear. If you don't use Linear, feel free to swap this out for JIRA or even Slack.","height":388.92815062755926,"width":885.2402868841493,"color":7},"id":"2f1a2eaa-3218-4878-9ae8-c423963144f7","name":"Sticky Note3","type":"n8n-nodes-base.stickyNote","position":[2800,20],"typeVersion":1},{"parameters":{"options":{}},"id":"202014a3-f7f0-4417-a3be-e32ec38d8727","name":"Loop Over Items","type":"n8n-nodes-base.splitInBatches","position":[720,500],"typeVersion":3},{"parameters":{"amount":2},"id":"81db4c72-44df-4b25-8045-2300a6be003b","name":"Wait","type":"n8n-nodes-base.wait","position":[1160,740],"webhookId":"f06eab66-30a7-48ad-90ee-cb3394eb2edb","typeVersion":1.1},{"parameters":{"url":"={{ $json.screenshotUrl }}","options":{}},"id":"36812416-8a90-482d-bc88-24426dec64fc","name":"Download Screenshot","type":"n8n-nodes-base.httpRequest","position":[1140,280],"typeVersion":4.2},{"parameters":{"name":"={{ $('Merge').item.json.url.urlEncode() }}","driveId":{"__rl":true,"mode":"list","value":"My Drive"},"folderId":{"__rl":true,"mode":"list","value":"1lAFxJPWcA_sOcjr3UUKKfFfoTwd4Stkh","cachedResultUrl":"https://drive.google.com/drive/folders/1lAFxJPWcA_sOcjr3UUKKfFfoTwd4Stkh","cachedResultName":"base_images"},"options":{"simplifyOutput":true}},"id":"5ad6070b-20e2-43a1-9543-8ef1a0324b8f","name":"Upload to Drive","type":"n8n-nodes-base.googleDrive","position":[1320,280],"typeVersion":3},{"parameters":{"operation":"appendOrUpdate","documentId":{"__rl":true,"mode":"list","value":"1RbobwHCJiYKnic6T-VA3kPr-Grd4Y_ZSQXqy2st_T84","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1RbobwHCJiYKnic6T-VA3kPr-Grd4Y_ZSQXqy2st_T84/edit?usp=drivesdk","cachedResultName":"Visual Regression List"},"sheetName":{"__rl":true,"mode":"list","value":"gid=0","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1RbobwHCJiYKnic6T-VA3kPr-Grd4Y_ZSQXqy2st_T84/edit#gid=0","cachedResultName":"Sheet1"},"columns":{"value":{"url":"={{ $('Merge').item.json.url }}","base":"={{ $json.id }}"},"schema":[{"id":"service","type":"string","display":true,"required":false,"displayName":"service","defaultMatch":false,"canBeUsedToMatch":true},{"id":"url","type":"string","display":true,"removed":false,"required":false,"displayName":"url","defaultMatch":false,"canBeUsedToMatch":true},{"id":"base","type":"string","display":true,"required":false,"displayName":"base","defaultMatch":false,"canBeUsedToMatch":true}],"mappingMode":"defineBelow","matchingColumns":["url"]},"options":{}},"id":"783e48b3-59cf-47b1-8a8c-5da89a68e413","name":"Update Base Image","type":"n8n-nodes-base.googleSheets","position":[1500,280],"typeVersion":4.5},{"parameters":{"mode":"combine","combineBy":"combineByPosition","options":{}},"id":"66d2cd07-4343-494a-bc3d-77800d7b3796","name":"Merge","type":"n8n-nodes-base.merge","position":[960,280],"typeVersion":3},{"parameters":{"rule":{"interval":[{"field":"weeks","triggerAtDay":[1],"triggerAtHour":6}]}},"id":"1e4e3d9c-dce2-4906-bbc7-390572eedb0c","name":"Schedule Trigger","type":"n8n-nodes-base.scheduleTrigger","position":[1840,300],"typeVersion":1.2},{"parameters":{"documentId":{"__rl":true,"mode":"list","value":"1RbobwHCJiYKnic6T-VA3kPr-Grd4Y_ZSQXqy2st_T84","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1RbobwHCJiYKnic6T-VA3kPr-Grd4Y_ZSQXqy2st_T84/edit?usp=drivesdk","cachedResultName":"Visual Regression List"},"sheetName":{"__rl":true,"mode":"list","value":"gid=0","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1RbobwHCJiYKnic6T-VA3kPr-Grd4Y_ZSQXqy2st_T84/edit#gid=0","cachedResultName":"Sheet1"},"options":{}},"id":"f7468cb4-70bd-4dc8-bf7c-578e684034b0","name":"Get URLs with Missing Base Images","type":"n8n-nodes-base.googleSheets","position":[420,400],"typeVersion":4.5},{"parameters":{"method":"POST","url":"https://api.apify.com/v2/acts/apify~screenshot-url/run-sync-get-dataset-items","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendBody":true,"specifyBody":"json","jsonBody":"={{\n{\n    \"delay\": 0,\n    \"format\": \"png\",\n    \"proxy\": {\n        \"useApifyProxy\": true\n    },\n    \"scrollToBottom\": false,\n    \"urls\": [\n        {\n            \"url\": $json.url\n        }\n    ],\n    \"viewportWidth\": 1280,\n    \"waitUntil\": \"domcontentloaded\",\n    \"waitUntilNetworkIdleAfterScroll\": false\n}\n}}","options":{}},"id":"07821523-c723-4268-af10-a34d87a1169e","name":"Run Webpage Screenshot","type":"n8n-nodes-base.httpRequest","position":[980,740],"typeVersion":4.2},{"parameters":{"method":"POST","url":"https://api.apify.com/v2/acts/apify~screenshot-url/run-sync-get-dataset-items","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendBody":true,"specifyBody":"json","jsonBody":"={{\n{\n    \"delay\": 0,\n    \"format\": \"png\",\n    \"proxy\": {\n        \"useApifyProxy\": true\n    },\n    \"scrollToBottom\": false,\n    \"urls\": [\n        {\n            \"url\": $json.url\n        }\n    ],\n    \"viewportWidth\": 1280,\n    \"waitUntil\": \"domcontentloaded\",\n    \"waitUntilNetworkIdleAfterScroll\": false\n}\n}}","options":{}},"id":"b9d3d4cf-b928-4e2c-ae23-60140ce0e821","name":"Run Webpage Screenshot1","type":"n8n-nodes-base.httpRequest","position":[2680,760],"typeVersion":4.2},{"parameters":{"conditions":{"options":{"version":2,"leftValue":"","caseSensitive":true,"typeValidation":"strict"},"combinator":"and","conditions":[{"id":"20b18a7e-bf98-4f39-baa9-4d965097526a","operator":{"type":"array","operation":"lengthGt","rightType":"number"},"leftValue":"={{ $json.output }}","rightValue":0}]},"options":{}},"id":"2ff89e93-c0dd-459b-a8a1-c26cbcb867a9","name":"Has Changes","type":"n8n-nodes-base.filter","position":[3080,220],"typeVersion":2.2},{"parameters":{"mode":"raw","jsonOutput":"={{\n{\n  ...$('Get Webpages List').item.json,\n  output: $json.output\n}\n}}\n","options":{}},"id":"c72c0fd1-a650-4653-bf28-21201e42df79","name":"Combine Row and Result","type":"n8n-nodes-base.set","position":[2900,220],"typeVersion":3.4},{"parameters":{"amount":1},"id":"e9311edd-1cf7-44d4-9a4b-8f147fb76a76","name":"Wait1","type":"n8n-nodes-base.wait","position":[3980,820],"webhookId":"6bbf2e65-bed1-4efc-bb31-09d12c644dc5","typeVersion":1.1},{"parameters":{"aggregate":"aggregateAllItemData","options":{}},"id":"c8c16592-2ed2-4d93-81d2-6c108a0123f8","name":"Aggregate","type":"n8n-nodes-base.aggregate","position":[3260,220],"typeVersion":1},{"parameters":{"teamId":"1c721608-321d-4132-ac32-6e92d04bb487","title":"=Visual Regression Report {{ $now.format('yyyy-MM-dd') }}","additionalFields":{"description":"=Visual Regression Workflow picked up the following changes:\n\n{{\n$json.data.map(row =>\n`### ${row.url}\n${row.output.map(issue =>\n`* **${issue.description}** - expected \"${issue.previous_state}\" but got \"${issue.current_state}\"`\n).join('\\n')}`\n).join('\\n');\n}}"}},"id":"df8fd2d5-5a85-4ec3-8de0-68dbd1c37866","name":"Create Report","type":"n8n-nodes-base.linear","position":[3440,220],"typeVersion":1},{"parameters":{},"id":"22451c4e-fda1-470a-b0ff-2ecd52f16a7a","name":"When clicking ‘Test workflow’","type":"n8n-nodes-base.manualTrigger","position":[220,400],"typeVersion":1},{"parameters":{"documentId":{"__rl":true,"mode":"list","value":"1RbobwHCJiYKnic6T-VA3kPr-Grd4Y_ZSQXqy2st_T84","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1RbobwHCJiYKnic6T-VA3kPr-Grd4Y_ZSQXqy2st_T84/edit?usp=drivesdk","cachedResultName":"Visual Regression List"},"sheetName":{"__rl":true,"mode":"list","value":"gid=0","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1RbobwHCJiYKnic6T-VA3kPr-Grd4Y_ZSQXqy2st_T84/edit#gid=0","cachedResultName":"Sheet1"},"filtersUI":{"values":[{"lookupColumn":"=row_number","lookupValue":"2"}]},"options":{}},"id":"2ec21b92-c5c0-4b65-bcbe-0a2305050201","name":"Get Webpages List","type":"n8n-nodes-base.googleSheets","position":[2040,300],"typeVersion":4.5},{"parameters":{"options":{}},"id":"e1dc2c39-0aa2-41ae-9d83-942e4ab6303d","name":"For Each Webpage...","type":"n8n-nodes-base.splitInBatches","position":[2360,360],"typeVersion":3},{"parameters":{"content":"## 4. Trigger Visual Regression Test Run\n[Read more about the Schedule Trigger](https://docs.n8n.io/integrations/builtin/core-nodes/n8n-nodes-base.scheduletrigger/)\n\nOnce we've generated our base images to compare with in Part A, we can now run our Visual Regression Tests. These tests are intended to check for unexpected changes to a webpage by using some form of image detection. To trigger Part B, we'll start with a schedule trigger and pull a list of webpages to test from Google Sheets.","height":408.0284015307624,"width":561.2038065501644,"color":7},"id":"d7e8addc-2dce-4e13-8118-eb624c804cb6","name":"Sticky Note4","type":"n8n-nodes-base.stickyNote","position":[1740,80],"typeVersion":1},{"parameters":{"content":"## 1. Get List of Webpages to Generate Base Images\n[Learn more about using Google Sheets](https://docs.n8n.io/integrations/builtin/app-nodes/n8n-nodes-base.googlesheets/)\n\nThis workflow is split into 2 parts: Part A will generate the \"base\" screenshots to compare new screenshots against. To capture these base screenshots, we'll use Google Sheets to hold our list of webpages and their screenshot references (we'll come on to that later).\n\nExample Sheet: https://docs.google.com/spreadsheets/d/e/2PACX-1vTXRZRi55dUbLAsWZboJqH5U-EK0ZRSse8pkqANAV4Ss70otpQ97zgT8YBd3dL4d2u2UC1TTx_o1o1R/pubhtml","height":487.40071048786325,"width":626.9985071319608,"color":7},"id":"07911370-c262-463a-9e4b-d1c4fecd1e60","name":"Sticky Note5","type":"n8n-nodes-base.stickyNote","position":[60,140],"typeVersion":1},{"parameters":{"content":"## 2. Generate Webpage Screenshot via Apify\n[Learn more about Apify.com](https://www.apify.com?fpr=414q6)\n\nTo generate a screenshot of the webpage, we'll need a third party service since this functionality is outside the scope of n8n. Feel free to pick whichever internal or external service works for you but I've had great experience using [Apify.com](https://www.apify.com?fpr=414q6) - a popular webscraping SaaS who offer a generous free plan and require very little configuration to get started.\n\nThe Apify \"actor\" (ie. a type of scraper) we'll be using is specifically designed to take webpage screenshots.","height":443.1120543367141,"width":653.369086691465,"color":7},"id":"9fa6ae40-b1f1-40e7-94e8-6d3e88e3fb92","name":"Sticky Note6","type":"n8n-nodes-base.stickyNote","position":[920,500],"typeVersion":1},{"parameters":{"content":"## 3. Upload Screenshot to Google Drive\n[Read more about using the Google Drive node](https://docs.n8n.io/integrations/builtin/app-nodes/n8n-nodes-base.googledrive/)\n\nOnce we have our screenshots, we'll download them from Apify and upload them to our Google Drive for safe keeping. After uploading, we'll capture the new Google Drive IDs for the images into our Google Sheet, this will allow us to reference them again when we perform the visual regression testing.","height":397.73072497123115,"width":808.188722669735,"color":7},"id":"0ace14bf-b256-4059-96dd-930d0dd1e171","name":"Sticky Note7","type":"n8n-nodes-base.stickyNote","position":[880,80],"typeVersion":1},{"parameters":{"url":"={{ $json.screenshotUrl }}","options":{"response":{"response":{"responseFormat":"file","outputPropertyName":"data_2"}}}},"id":"b80ebb93-4f83-43aa-bff0-c39269a5377c","name":"Download New Screenshot","type":"n8n-nodes-base.httpRequest","position":[2860,760],"typeVersion":4.2},{"parameters":{"mode":"combine","combineBy":"combineByPosition","options":{}},"id":"2b08f5fc-2101-4b59-a96d-5c9de6fb1982","name":"Combine Screenshots","type":"n8n-nodes-base.merge","position":[3060,580],"typeVersion":3},{"parameters":{"content":"### Part B. Run Visual Regression Test\nIn this part of the workflow, we'll retrieve our list of webpages to test with our AI vision model. This part can be run as many times as required.","height":111.52173490405977,"width":394.03359370567625,"color":4},"id":"9f7d3169-9c9e-4be0-91dc-177826e9a3ec","name":"Sticky Note8","type":"n8n-nodes-base.stickyNote","position":[1740,-60],"typeVersion":1},{"parameters":{"content":"## Try It Out!\n\n### This workflow implements an approach to Visual Regression Testing - a means to test websites for defects - using AI Vision Models.\n\nThis workflow uses a Google Sheet to track a list of webpages to test and is split into 2 parts; Part A generates the base screenshots of the list and Part B runs the visual regression testing.\n\nThe example spreadsheet can be found here: https://docs.google.com/spreadsheets/d/e/2PACX-1vTXRZRi55dUbLAsWZboJqH5U-EK0ZRSse8pkqANAV4Ss70otpQ97zgT8YBd3dL4d2u2UC1TTx_o1o1R/pubhtml\n\n**[Apify.com](https://www.apify.com?fpr=414q6)** is the screenshot generator of choice and a free account with $5 in credit is available via this [link](https://www.apify.com?fpr=414q6).\n\n\n### Need Help?\nJoin the [Discord](https://discord.com/invite/XPKeKXeB7d) or ask in the [Forum](https://community.n8n.io/)!","height":473.4987906976746,"width":553.2963720930223},"id":"5ba3ac45-dc0c-4188-8da5-348c8c2839e5","name":"Sticky Note9","type":"n8n-nodes-base.stickyNote","position":[-520,140],"typeVersion":1},{"parameters":{"promptType":"define","text":"Identify changes between the base image and test image.","hasOutputParser":true,"messages":{"messageValues":[{"message":"=You help with visual regression testing for websites. Identify changes to text content, images, colors, position and layouts of the elements in the screenshots. Ignore text styling or casing changes.\nThe first image will be the base image and the second image will be the test. Note all changes to the test image which differ from the base. If there are no changes, it is okay to return an empty array."},{"type":"HumanMessagePromptTemplate","messageType":"imageBinary","binaryImageDataKey":"data_1"},{"type":"HumanMessagePromptTemplate","messageType":"imageBinary","binaryImageDataKey":"data_2"}]}},"id":"26ce9716-b956-4c16-a29a-fdb60f0d64b1","name":"Visual Regression Agent","type":"@n8n/n8n-nodes-langchain.chainLlm","position":[3520,660],"typeVersion":1.4}],"connections":{"Wait":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"Merge":{"main":[[{"node":"Download Screenshot","type":"main","index":0}]]},"Wait1":{"main":[[{"node":"For Each Webpage...","type":"main","index":0}]]},"Aggregate":{"main":[[{"node":"Create Report","type":"main","index":0}]]},"Base Image":{"main":[[{"node":"Combine Screenshots","type":"main","index":0}]]},"Has Changes":{"main":[[{"node":"Aggregate","type":"main","index":0}]]},"Loop Over Items":{"main":[[{"node":"Merge","type":"main","index":1}],[{"node":"Run Webpage Screenshot","type":"main","index":0}]]},"Upload to Drive":{"main":[[{"node":"Update Base Image","type":"main","index":0}]]},"Schedule Trigger":{"main":[[{"node":"Get Webpages List","type":"main","index":0}]]},"Get Webpages List":{"main":[[{"node":"For Each Webpage...","type":"main","index":0}]]},"Combine Screenshots":{"main":[[{"node":"Visual Regression Agent","type":"main","index":0}]]},"Download Screenshot":{"main":[[{"node":"Upload to Drive","type":"main","index":0}]]},"For Each Webpage...":{"main":[[{"node":"Combine Row and Result","type":"main","index":0}],[{"node":"Base Image","type":"main","index":0},{"node":"Run Webpage Screenshot1","type":"main","index":0}]]},"Combine Row and Result":{"main":[[{"node":"Has Changes","type":"main","index":0}]]},"Run Webpage Screenshot":{"main":[[{"node":"Wait","type":"main","index":0}]]},"Download New Screenshot":{"main":[[{"node":"Combine Screenshots","type":"main","index":1}]]},"Run Webpage Screenshot1":{"main":[[{"node":"Download New Screenshot","type":"main","index":0}]]},"Visual Regression Agent":{"main":[[{"node":"Wait1","type":"main","index":0}]]},"Google Gemini Chat Model":{"ai_languageModel":[[{"node":"Visual Regression Agent","type":"ai_languageModel","index":0}]]},"Structured Output Parser":{"ai_outputParser":[[{"node":"Visual Regression Agent","type":"ai_outputParser","index":0}]]},"Get URLs with Missing Base Images":{"main":[[{"node":"Loop Over Items","type":"main","index":0},{"node":"Merge","type":"main","index":0}]]},"When clicking ‘Test workflow’":{"main":[[{"node":"Get URLs with Missing Base Images","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"4e6a3c48-176f-446f-9f53-b79684739b93","triggerCount":0,"tags":[{"createdAt":"2025-02-11T23:59:41.483Z","updatedAt":"2025-02-14T16:18:26.979Z","id":"dzhL8PxGOvRSKz2J","name":"ANCORA IN TEST"},{"createdAt":"2025-02-12T01:27:20.078Z","updatedAt":"2025-02-12T01:27:20.078Z","id":"wKG1EEc4KjZp5Caj","name":"IMAGE"}]}