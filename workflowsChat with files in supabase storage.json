{"createdAt":"2025-02-12T00:09:28.802Z","updatedAt":"2025-02-12T01:48:52.000Z","id":"M9NwkLeb5UQ1CJ7A","name":"Chat with files in supabase storage","active":false,"nodes":[{"parameters":{"method":"POST","url":"=https://yqtvdcvjboenlblgcivl.supabase.co/storage/v1/object/list/private","authentication":"predefinedCredentialType","nodeCredentialType":"supabaseApi","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"prefix\": \"\",\n  \"limit\": 100,\n  \"offset\": 0,\n  \"sortBy\": {\n    \"column\": \"name\",\n    \"order\": \"asc\"\n  }\n}","options":{}},"id":"98723059-d891-475f-8e6d-030dd823310c","name":"Get All files","type":"n8n-nodes-base.httpRequest","position":[1000,1300],"typeVersion":4.2},{"parameters":{"jsonMode":"expressionData","jsonData":"={{ $('Merge').item.json.data ?? $('Merge').item.json.text }}","options":{"metadata":{"metadataValues":[{"name":"=file_id","value":"={{ $json.id }}"}]}}},"id":"a0b1dce5-8aa6-4cdf-b861-07c445a1c847","name":"Default Data Loader","type":"@n8n/n8n-nodes-langchain.documentDefaultDataLoader","position":[2380,1500],"typeVersion":1},{"parameters":{"chunkSize":500,"chunkOverlap":200,"options":{}},"id":"0657238d-bf6b-4511-a96d-534172a8c148","name":"Recursive Character Text Splitter","type":"@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter","position":[2380,1680],"typeVersion":1},{"parameters":{"operation":"pdf","options":{}},"id":"e8205f82-08b8-4361-990d-a6f46547977e","name":"Extract Document PDF","type":"n8n-nodes-base.extractFromFile","position":[1840,1400],"typeVersion":1,"alwaysOutputData":false},{"parameters":{"model":"text-embedding-3-small","options":{}},"id":"5c7cf3ed-4725-4a95-9a3e-95aec1b5bfb0","name":"Embeddings OpenAI","type":"@n8n/n8n-nodes-langchain.embeddingsOpenAi","position":[2200,1480],"typeVersion":1},{"parameters":{"tableId":"files","fieldsUi":{"fieldValues":[{"fieldId":"name","fieldValue":"={{ $('Loop Over Items').item.json.name }}"},{"fieldId":"storage_id","fieldValue":"={{ $('Loop Over Items').item.json.id }}"}]}},"id":"fe42212a-f38a-4fac-a554-05b6fa03e3ef","name":"Create File record2","type":"n8n-nodes-base.supabase","position":[2140,1300],"typeVersion":1},{"parameters":{"conditions":{"options":{"version":2,"leftValue":"","caseSensitive":true,"typeValidation":"strict"},"combinator":"and","conditions":[{"id":"9b14e306-a04d-40f7-bc5b-b8eda8d8f7f2","operator":{"type":"boolean","operation":"true","singleValue":true},"leftValue":"={{ \n    !$('Aggregate').item.json.data || \n    !Array.isArray($('Aggregate').item.json.data) || \n    !$('Aggregate').item.json.data.some(item => \n        item.storage_id === $('Loop Over Items').item.json.id \n    ) \n}}","rightValue":""},{"id":"c3c0af88-9aea-4539-8948-1b69e601c27c","operator":{"type":"string","operation":"notEquals"},"leftValue":"={{ $json.name }}","rightValue":".emptyFolderPlaceholder"}]},"options":{}},"id":"81a85e6f-e91d-4dfc-946a-2faf8c5c3b22","name":"If","type":"n8n-nodes-base.if","position":[1320,1300],"typeVersion":2.2},{"parameters":{"operation":"getAll","tableId":"files"},"id":"a4f8ed69-4453-406e-99a7-ee950c0d0de1","name":"Get All Files","type":"n8n-nodes-base.supabase","position":[620,1300],"typeVersion":1,"alwaysOutputData":true},{"parameters":{"url":"=https://yqtvdcvjboenlblgcivl.supabase.co/storage/v1/object/private/{{ $json.name }}","authentication":"predefinedCredentialType","nodeCredentialType":"supabaseApi","options":{}},"id":"d61364e0-23ff-4ba2-87a3-e8b3afead4e5","name":"Download","type":"n8n-nodes-base.httpRequest","position":[1500,1300],"typeVersion":4.2},{"parameters":{"batchSize":"=1","options":{}},"id":"56dc5659-2971-4f4a-9631-2171b5087a0f","name":"Loop Over Items","type":"n8n-nodes-base.splitInBatches","position":[1160,1300],"typeVersion":3},{"parameters":{},"id":"8bdb8140-60c6-4493-83e4-93725b28ded9","name":"When clicking ‘Test workflow’","type":"n8n-nodes-base.manualTrigger","position":[440,1300],"typeVersion":1},{"parameters":{"aggregate":"aggregateAllItemData","options":{}},"id":"63cce90f-7865-426b-95c0-c9d6475e7384","name":"Aggregate","type":"n8n-nodes-base.aggregate","position":[820,1300],"typeVersion":1,"alwaysOutputData":true},{"parameters":{"options":{}},"id":"f8b97d26-cadd-4ce3-92eb-4090aca5108a","name":"When chat message received","type":"@n8n/n8n-nodes-langchain.chatTrigger","position":[1400,380],"webhookId":"3c40d311-7996-4ed4-b2fa-c73bea5f4cf5","typeVersion":1.1},{"parameters":{"options":{}},"id":"0954e881-93a4-4108-9bdb-96ed02a5fe55","name":"OpenAI Chat Model1","type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","position":[1540,580],"typeVersion":1},{"parameters":{"model":"text-embedding-3-small","options":{}},"id":"e36ba37d-106f-4879-a6a2-0a7f4c6c5884","name":"Embeddings OpenAI2","type":"@n8n/n8n-nodes-langchain.embeddingsOpenAi","position":[1620,860],"typeVersion":1},{"parameters":{"options":{}},"id":"85ce780c-1098-478f-9dbc-65d2b18ce3ff","name":"OpenAI Chat Model2","type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","position":[1900,720],"typeVersion":1},{"parameters":{"name":"knowledge_base","description":"Retrieve data about user request","topK":8},"id":"353dbc0b-322e-4f7d-98a3-4dce0618406c","name":"Vector Store Tool1","type":"@n8n/n8n-nodes-langchain.toolVectorStore","position":[1700,580],"typeVersion":1},{"parameters":{"rules":{"values":[{"conditions":{"options":{"version":1,"leftValue":"","caseSensitive":true,"typeValidation":"strict"},"combinator":"and","conditions":[{"operator":{"type":"boolean","operation":"true","singleValue":true},"leftValue":"={{$binary.data?.fileExtension == undefined }}","rightValue":"txt"}]},"renameOutput":true,"outputKey":"txt"},{"conditions":{"options":{"version":1,"leftValue":"","caseSensitive":true,"typeValidation":"strict"},"combinator":"and","conditions":[{"id":"bf04cbec-dd86-4607-988f-4c96b6fd4b58","operator":{"type":"string","operation":"equals"},"leftValue":"={{$binary.data.fileExtension  }}","rightValue":"pdf"}]},"renameOutput":true,"outputKey":"pdf"}]},"options":{}},"id":"6ecb55b5-c8eb-4be9-a52b-459352c62376","name":"Switch","type":"n8n-nodes-base.switch","position":[1660,1300],"typeVersion":3.1},{"parameters":{"mode":"insert","tableName":{"__rl":true,"mode":"list","value":"documents","cachedResultName":"documents"},"options":{"queryName":"match_documents"}},"id":"6b3d5e7f-3525-4244-b29b-8498fe9883bb","name":"Insert into Supabase Vectorstore","type":"@n8n/n8n-nodes-langchain.vectorStoreSupabase","position":[2300,1300],"typeVersion":1},{"parameters":{},"id":"23947d6d-35c5-4f64-9f35-b504a2309647","name":"Merge","type":"n8n-nodes-base.merge","position":[1980,1300],"typeVersion":3},{"parameters":{"options":{}},"id":"c8b52dff-31f8-488a-8058-b242045bfdee","name":"AI Agent","type":"@n8n/n8n-nodes-langchain.agent","position":[1620,380],"typeVersion":1.7},{"parameters":{"tableName":{"__rl":true,"mode":"list","value":"documents","cachedResultName":"documents"},"options":{"metadata":{"metadataValues":[{"name":"file_id","value":"300b0128-0955-4058-b0d3-a9aefe728432"}]}}},"id":"ffefb6ec-01b3-48db-93ad-5f456abf44dc","name":"Supabase Vector Store","type":"@n8n/n8n-nodes-langchain.vectorStoreSupabase","position":[1620,740],"typeVersion":1},{"parameters":{"content":"### Replace Storage name, database ID and credentials.","height":89.3775420487804},"id":"10feb318-edc5-4f15-a4c1-04ad8c826c5e","name":"Sticky Note","type":"n8n-nodes-base.stickyNote","position":[940,1180],"typeVersion":1},{"parameters":{"content":"### Replace credentials.","height":80},"id":"19b9ea1d-ccfb-4f30-b96f-012d31fb2bb8","name":"Sticky Note1","type":"n8n-nodes-base.stickyNote","position":[580,1180],"typeVersion":1},{"parameters":{"content":"### Replace credentials.","height":80},"id":"e3467c4f-3f3e-4a04-8700-46ac3e659015","name":"Sticky Note2","type":"n8n-nodes-base.stickyNote","position":[2140,1180],"typeVersion":1},{"parameters":{"content":"### Replace Storage name, database ID and credentials.","height":89.3775420487804},"id":"499d4700-8de5-4afd-b04f-ac6dd3f43355","name":"Sticky Note3","type":"n8n-nodes-base.stickyNote","position":[1440,1180],"typeVersion":1},{"parameters":{"content":"### Replace credentials.","height":80},"id":"f5a9debd-2005-48e9-97c5-bbe7f0f3c06a","name":"Sticky Note4","type":"n8n-nodes-base.stickyNote","position":[2100,1620],"typeVersion":1},{"parameters":{"content":"### Replace credentials.","height":80},"id":"e0bfb43a-7c53-4dbd-b604-94f8ba8bc294","name":"Sticky Note5","type":"n8n-nodes-base.stickyNote","position":[1740,880],"typeVersion":1},{"parameters":{"content":"### ... or watch set up video [10 min]\n[![Youtube Thumbnail](https://cflobdhpqwnoisuctsoc.supabase.co/storage/v1/object/public/my_storage/Chat%20with%20Files%20-%20Blur.png)](https://www.youtube.com/watch?v=glWUkdZe_3w)\n","height":239.5888196628349,"width":330.5152611046425,"color":7},"id":"0a5de818-6ef4-4933-a2c2-d194ae1d31a2","name":"Sticky Note9","type":"n8n-nodes-base.stickyNote","position":[80,460],"typeVersion":1},{"parameters":{"content":"![5min Logo](https://cflobdhpqwnoisuctsoc.supabase.co/storage/v1/object/public/my_storage/banner.png)\n## AI Agent To Chat With Files In Supabase Storage\n**Made by [Mark Shcherbakov](https://www.linkedin.com/in/marklowcoding/) from community [5minAI](https://www.skool.com/5minai-2861)**\n\nManually retrieving and analyzing specific information from large document repositories is time-consuming and inefficient. This workflow automates the process by vectorizing documents and enabling AI-powered interactions, making it easy to query and retrieve context-based information from uploaded files.\n\nThe workflow integrates Supabase with an AI-powered chatbot to process, store, and query text and PDF files. The steps include:\n- Fetching and comparing files to avoid duplicate processing.\n- Handling file downloads and extracting content based on the file type.\n- Converting documents into vectorized data for contextual information retrieval.\n- Storing and querying vectorized data from a Supabase vector store.\n\n","height":497.1532689930921,"width":636.2128494576581,"color":7},"id":"bd7b9bb8-ebc7-44bf-b492-7447e2c9f927","name":"Sticky Note7","type":"n8n-nodes-base.stickyNote","position":[-220,-60],"typeVersion":1},{"parameters":{"content":"### Set up steps\n\n1. **Fetch File List from Supabase**:\n   - Use Supabase to retrieve the stored file list from a specified bucket.\n   - Add logic to manage empty folder placeholders returned by Supabase, avoiding incorrect processing.\n\n2. **Compare and Filter Files**:\n   - Aggregate the files retrieved from storage and compare them to the existing list in the Supabase `files` table.\n   - Exclude duplicates and skip placeholder files to ensure only unprocessed files are handled.\n\n3. **Handle File Downloads**:\n   - Download new files using detailed storage configurations for public/private access.\n   - Adjust the storage settings and GET requests to match your Supabase setup.\n\n4. **File Type Processing**:\n   - Use a Switch node to target specific file types (e.g., PDFs or text files).\n   - Employ relevant tools to process the content:\n     - For PDFs, extract embedded content.\n     - For text files, directly process the text data.\n\n5. **Content Chunking**:\n   - Break large text data into smaller chunks using the Text Splitter node.\n   - Define chunk size (default: 500 tokens) and overlap to retain necessary context across chunks.\n\n6. **Vector Embedding Creation**:\n   - Generate vectorized embeddings for the processed content using OpenAI's embedding tools.\n   - Ensure metadata, such as file ID, is included for easy data retrieval.\n\n7. **Store Vectorized Data**:\n   - Save the vectorized information into a dedicated Supabase vector store.\n   - Use the default schema and table provided by Supabase for seamless setup.\n\n8. **AI Chatbot Integration**:\n   - Add a chatbot node to handle user input and retrieve relevant document chunks.\n   - Use metadata like file ID for targeted queries, especially when multiple documents are involved.","height":545.9087885077763,"width":280.2462120317618,"color":7},"id":"39d3e027-82a2-4a20-a752-d36dda4d6e1c","name":"Sticky Note6","type":"n8n-nodes-base.stickyNote","position":[-220,460],"typeVersion":1},{"parameters":{"content":"## Scenario 2 - AI agent","height":809.7437181509877,"width":951.7421645394404,"color":5},"id":"aaca34d0-bf0e-4e44-b0a9-4e70c672ca3a","name":"Sticky Note8","type":"n8n-nodes-base.stickyNote","position":[1140,240],"typeVersion":1},{"parameters":{"content":"## Scenario 1 - Flow for adding new files from Supabase storage","height":739.2522526116408,"width":2304.723519246249,"color":5},"id":"13f1ae92-0c00-4ac9-a0e1-70fbcacb9dd7","name":"Sticky Note10","type":"n8n-nodes-base.stickyNote","position":[340,1120],"typeVersion":1}],"connections":{"If":{"main":[[{"node":"Download","type":"main","index":0}],[{"node":"Loop Over Items","type":"main","index":0}]]},"Merge":{"main":[[{"node":"Create File record2","type":"main","index":0}]]},"Switch":{"main":[[{"node":"Merge","type":"main","index":0}],[{"node":"Extract Document PDF","type":"main","index":0}]]},"Download":{"main":[[{"node":"Switch","type":"main","index":0}]]},"Aggregate":{"main":[[{"node":"Get All files","type":"main","index":0}]]},"Get All Files":{"main":[[{"node":"Aggregate","type":"main","index":0}]]},"Get All files":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"Loop Over Items":{"main":[[],[{"node":"If","type":"main","index":0}]]},"Embeddings OpenAI":{"ai_embedding":[[{"node":"Insert into Supabase Vectorstore","type":"ai_embedding","index":0}]]},"Embeddings OpenAI2":{"ai_embedding":[[{"node":"Supabase Vector Store","type":"ai_embedding","index":0}]]},"OpenAI Chat Model1":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"OpenAI Chat Model2":{"ai_languageModel":[[{"node":"Vector Store Tool1","type":"ai_languageModel","index":0}]]},"Vector Store Tool1":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"Create File record2":{"main":[[{"node":"Insert into Supabase Vectorstore","type":"main","index":0}]]},"Default Data Loader":{"ai_document":[[{"node":"Insert into Supabase Vectorstore","type":"ai_document","index":0}]]},"Extract Document PDF":{"main":[[{"node":"Merge","type":"main","index":1}]]},"Supabase Vector Store":{"ai_vectorStore":[[{"node":"Vector Store Tool1","type":"ai_vectorStore","index":0}]]},"When chat message received":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"Insert into Supabase Vectorstore":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"Recursive Character Text Splitter":{"ai_textSplitter":[[{"node":"Default Data Loader","type":"ai_textSplitter","index":0}]]},"When clicking ‘Test workflow’":{"main":[[{"node":"Get All Files","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"a5c409ef-f939-4767-b009-6109c238d451","triggerCount":0,"tags":[{"createdAt":"2025-02-12T01:25:44.824Z","updatedAt":"2025-02-12T01:25:44.824Z","id":"bzJZk40lpXglcXDs","name":"CHAT"},{"createdAt":"2025-02-11T23:59:41.483Z","updatedAt":"2025-02-14T16:18:26.979Z","id":"dzhL8PxGOvRSKz2J","name":"ANCORA IN TEST"}]}